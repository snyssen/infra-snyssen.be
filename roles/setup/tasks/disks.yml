- name: Creating mounting directories
  become: yes
  ansible.builtin.file:
    path: "{{ item.path  }}"
    state: directory
    owner: "1000"
    group: "1000"
  with_items: "{{ disks_mounts }}"

- name: Creating ext4 filesystem on drives
  become: yes
  community.general.filesystem:
    fstype: ext4
    state: present
    dev: "{{ item.src }}"
  with_items: "{{ disks_mounts }}"

- name: Mounting disks
  become: yes
  ansible.builtin.mount:
    path: "{{ item.path }}"
    src: "{{ item.src }}"
    fstype: auto
    opts: defaults
    state: present
  with_items: "{{ disks_mounts }}"

- name: Creating storage mount
  become: yes
  ansible.builtin.file:
    path: /mnt/storage
    state: directory
- name: Mounting storage volume w/ MergerFS
  become: yes
  ansible.builtin.mount:
    path: /mnt/storage
    src: /mnt/disk*
    fstype: fuse.mergerfs
    opts: defaults,nonempty,allow_other,use_ino,cache.files=off,moveonenospc=true,category.create=mfs,minfreespace=20G,fsname=mergerfs-storage
    state: present

- name: Deploying SnapRAID configuration
  become: yes
  ansible.builtin.template:
    src: snapraid.conf.j2
    dest: /etc/snapraid.conf
    owner: root
    group: root
    mode: '0644'
- name: Deploying SnapRAID-runner configuration
  become: yes
  ansible.builtin.template:
    src: "{{ item }}"
    dest: /opt/snapraid-runner/{{ item[:-3] }} # `[:-3]` Is used to remove the `.j2` extension from the template file
    owner: root
    group: root
    mode: '0600'
  with_items:
    - snapraid-runner.conf.j2
    - snapraid-runner.no-threshold.conf.j2
- name: Adds crontab task for SnapRAID-runner
  become: yes
  ansible.builtin.cron:
    name: SnapRAID-runner
    minute: "0"
    hour: "01"
    user: root
    job: python3 /opt/snapraid-runner/snapraid-runner.py -c /opt/snapraid-runner/snapraid-runner.conf
    state: present
- name: Adding log directory for SnapRAID-runner
  become: yes
  ansible.builtin.file:
    path: /var/log/snapraid #/snapraid.log
    state: directory
    
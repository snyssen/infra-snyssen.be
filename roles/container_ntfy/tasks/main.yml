- name: Creating folders
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: directory
  loop:
    - path: "{{ docker_mounts_directory }}/ntfy/cache"
    - path: "{{ docker_mounts_directory }}/ntfy/auth"
    - path: "{{ docker_mounts_directory }}/ntfy/mollysocket"

- ansible.builtin.set_fact:
    ntfy__users_entries: |-
      [
        {% for usr in ntfy__users %}
        "{{ usr.name }}:{{ usr.password_hash }}:{{ usr.role | default('user') }}",
        {% endfor %}
      ]
    # First topic permission is hardcoded to al0low unified push
    ntfy__topics_entries: |-
      [
        {% for topic in ntfy__anonymous_topics %}
        "*:{{ topic.pattern }}:{{ topic.permission }}",
        {% endfor %}
        {% for usr in ntfy__users %}
        {% if usr.topics is defined %}
        {% for topic in usr.topics %}
        "{{ usr.name }}:{{ topic.pattern }}:{{ topic.permission }}",
        {% endfor %}
        {% endif %}
        {% endfor %}
      ]
    ntfy__tokens_entries: |-
      [
        {% for usr in ntfy__users %}
        {% if usr.token is defined and usr.token.startswith('tk_') %}
        "{{ usr.name }}:{{ usr.token }}",
        {% endif %}
        {% endfor %}
      ]

- ansible.builtin.include_role:
    name: snyssen.compose_deploy
  vars:
    stack_name: "ntfy"

- name: Create monitors
  lucasheld.uptime_kuma.monitor:
    name: "{{ item.name }}"
    type: http
    url: "{{ item.url }}"
  loop:
    - name: ntfy
      url: "https://ntfy.{{ ansible_fqdn }}"

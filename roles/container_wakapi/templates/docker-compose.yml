version: '3'
services:
  wakapi:
    image: ghcr.io/muety/wakapi:2
    container_name: wakapi
    restart: unless-stopped
    networks:
      - web
      - monitoring
    volumes:
      - "{{ docker_mounts_directory }}/wakapi/data:/data"
    environment:
      WAKAPI_PASSWORD_SALT: "{{ wakapi__salt }}"
      WAKAPI_INSECURE_COOKIES: "false"
      WAKAPI_ALLOW_SIGNUP: "true"
      WAKAPI_DISABLE_FRONTPAGE: "true"
      WAKAPI_PUBLIC_URL: "https://wakapi.{{ ansible_fqdn }}"
      WAKAPI_EXPOSE_METRICS: "true"
      WAKAPI_MAIL_SENDER: "{{ smtp__from }}"
      WAKAPI_MAIL_SMTP_HOST: "{{ smtp__host }}"
      WAKAPI_MAIL_SMTP_PORT: "{{ smtp__port }}"
      WAKAPI_MAIL_SMTP_USER: "{{ smtp__user }}"
      WAKAPI_MAIL_SMTP_PASS: "{{ smtp__pass | replace('$', '$$') }}"
      WAKAPI_MAIL_SMTP_TLS: "{{ smtp__tls | lower }}"
    labels:
      - traefik.enable=true
      - traefik.docker.network=web
      - traefik.http.routers.wakapi.entryPoints=websecure
      - traefik.http.routers.wakapi.rule=Host(`wakapi.{{ ansible_fqdn }}`)
      # Since config allows for disabling signup but does not offer an alternative for creating accounts
      # We instead allow them but add basic auth on signup path
      - traefik.http.routers.wakapi-signup.entryPoints=websecure
      - traefik.http.routers.wakapi-signup.rule=Host(`wakapi.{{ ansible_fqdn }}`) && Path(`/signup`)
      - traefik.http.routers.wakapi-signup.middlewares=auth

networks:
  web:
    external: true
  monitoring:
    external: true

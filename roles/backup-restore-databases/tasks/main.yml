- ansible.builtin.set_fact:
    db_restore_available:
      # TODO: 'user' and 'database' should have same value as service (the key here) and could thus be removed from here
      nextcloud:
        directory: /mnt/storage/backups/nextcloud
        type: pgsql
        user: nextcloud
        password: "{{ nextcloud__postgres_password }}"
        database: nextcloud
      recipes:
        directory: /mnt/storage/backups/recipes
        type: pgsql
        user: djangouser
        password: "{{ recipes__db_password }}"
        database: djangodb
      photoprism:
        directory: /mnt/storage/backups/photoprism/mysql
        type: photoprism

- ansible.builtin.set_fact:
    db_restore_selected: >-
      {{
        db_restore_available | dict2items | selectattr('key', 'in', db_restore_include) | list | items2dict
        if db_restore_include is defined and db_restore_include | length > 0 else
        db_restore_available | dict2items | rejectattr('key', 'in', db_restore_exclude) | list | items2dict
      }}

- ansible.builtin.include_tasks: restore_individual_db.yml
  loop: "{{ db_restore_selected | dict2items }}"

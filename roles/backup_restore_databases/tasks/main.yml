- name: Ensure databases are running
  ansible.builtin.include_role:
    name: stacks_set_state
  vars:
    stacks_state: present
    stacks_include:
      - databases
      - photoprism

- name: Selecting pgsql databases
  ansible.builtin.include_tasks: pgsql_restore.yml
  loop: "{{ db__pg_databases }}"
  loop_control:
    loop_var: db
    label: "{'name': '{{ db.name }}', 'password': '***'}"
  when:
    (db_restore_include is not defined and db_restore_exclude is not defined)
    or (db.name in db_restore_include and db.name not in db_restore_exclude)

- name: Restore Immich database
  ansible.builtin.include_tasks: immich_restore.yml
  vars:
    pg_backup_container: immich_db_dumper
  loop:
    - name: immich
      password: "{{ immich__db_password }}"
  loop_control:
    loop_var: db
    label: "{'name': '{{ db.name }}', 'password': '***'}"
  when:
    (db_restore_include is not defined and db_restore_exclude is not defined)
    or (db.name in db_restore_include | default([]) and db.name not in db_restore_exclude | default([]))

- name: Selecting Photoprism
  ansible.builtin.include_tasks: photoprism_restore.yml
  loop:
    - name: photoprism
      password: "{{ photoprism__mariadb_password }}"
  loop_control:
    loop_var: db
    label: "{'name': '{{ db.name }}', 'password': '***'}"
  when:
    (db_restore_include is not defined and db_restore_exclude is not defined)
    or (db.name in db_restore_include and db.name not in db_restore_exclude)

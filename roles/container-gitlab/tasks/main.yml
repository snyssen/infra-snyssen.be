- name: Creating folders
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
  with_items:
    # For GitLab itself
    - "{{ docker_mounts_directory }}/gitlab/config"
    - "{{ docker_mounts_directory }}/gitlab/logs"
    - "{{ docker_mounts_directory }}/gitlab/data"
    - "/mnt/storage/gitlab/registry"
    # gitlab backups
    - "/mnt/storage/backups/gitlab"
    # For GitLab runner
    - "{{ docker_mounts_directory }}/gitlab-runner"

- name: Deploying gitlab-runner config file
  ansible.builtin.template:
    src: config.toml.j2
    dest: "{{ docker_mounts_directory }}/gitlab-runner/config.toml"

- ansible.builtin.include_role:
    name: container-deploy
  vars:
    container_name: "gitlab"
    docker_compose_start: yes

- name: Adds backup cron job
  become: yes
  ansible.builtin.cron:
    name: gitlab_backup
    minute: "00"
    hour: "00"
    user:  root
    job: "docker exec -t gitlab gitlab-backup create && curl -m 10 --retry 5 https://hc-ping.com/{{ gitlab.healthcheck_id }}"
    state: present
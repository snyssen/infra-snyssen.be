- name: Creating folders
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
  with_items:
    # postgres
    - "{{ docker_mounts_directory }}/nextcloud/postgresql"
    # redis
    - "{{ docker_mounts_directory }}/nextcloud/redis"
    # nextcloud
    - /mnt/storage/nextcloud
    # onlyoffice
    - /mnt/storage/onlyoffice/data
    - /mnt/storage/onlyoffice/logs
    # backups
    - /mnt/storage/backups/nextcloud

- name: Deploying hooks for database backups
  ansible.builtin.copy:
    src: pgsql_backups_hooks
    dest: "{{ docker_compose_directory }}/nextcloud/hooks/"
    mode: 0770

- ansible.builtin.include_role:
    name: snyssen.compose_deploy
  vars:
    container_name: "nextcloud"

- name: Adds cron job for Nextcloud
  become: yes
  ansible.builtin.cron:
    name: Nextcloud
    minute: "*/5"
    user: root
    job: "docker exec -u www-data nextcloud php cron.php && curl -fsS -m 10 --retry 5 -o /dev/null https://hc-ping.com/{{ nextcloud__healthcheck_id }}"
    state: present

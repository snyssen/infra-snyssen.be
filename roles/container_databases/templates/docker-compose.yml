version: "2"
services:
  postgres:
    image: postgres:16
    container_name: postgres
    restart: unless-stopped
    environment:
      POSTGRES_PASSWORD: "{{ db__pg_password }}"
    volumes:
      - "{{ docker_mounts_directory }}/databases/postgres/data:/var/lib/postgresql/data"
    # Expose port directly on host so ansible can connect to manage databases
    ports:
      - "5432:5432"
    networks:
      - db
    mem_limit: 64m

  pgadmin:
    image: dpage/pgadmin4:8.3
    container_name: pgadmin
    restart: unless-stopped
    environment:
      PGADMIN_DEFAULT_EMAIL: "{{ db__pgadmin_email }}"
      PGADMIN_DEFAULT_PASSWORD: "{{ db__pgadmin_password }}"
      PGADMIN_CONFIG_CONSOLE_LOG_LEVEL: "10" # debug
    volumes:
      - "{{ docker_mounts_directory }}/databases/postgres/servers.json:/pgadmin4/servers.json:ro"
    depends_on:
      - postgres
    networks:
      - db
      - web
    labels:
      - traefik.enable=true
      - traefik.http.routers.pgadmin.entryPoints=websecure
      - traefik.http.routers.pgadmin.rule=Host(`pgadmin.{{ ansible_fqdn }}`)
      - traefik.http.routers.pgadmin.service=pgadmin
      - traefik.http.services.pgadmin.loadBalancer.server.port=80
    mem_limit: 512m

networks:
  db:
    external: true
  web:
    external: true

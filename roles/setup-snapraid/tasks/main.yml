- name: Enabling SnapRAID COPR repos
  become: yes
  community.general.copr:
    name: pauken/SnapRAID
    state: enabled
- name: Installing SnapRAID
  become: yes
  ansible.builtin.dnf:
    name: snapraid
    state: latest

- name: Cloning SnapRAID-runner
  become: yes
  ansible.builtin.git:
    # git clone https://github.com/Chronial/snapraid-runner.git /opt/snapraid-runner
    repo: https://github.com/Chronial/snapraid-runner
    dest: /opt/snapraid-runner
    clone: yes
    update: yes

- name: Deploying SnapRAID configuration
  become: yes
  ansible.builtin.template:
    src: snapraid.conf.j2
    dest: /etc/snapraid.conf
    owner: root
    group: root
    mode: "0644"

- name: Deploying SnapRAID-runner configuration
  become: yes
  ansible.builtin.template:
    src: "{{ item }}"
    dest: /opt/snapraid-runner/{{ item[:-3] }} # `[:-3]` Is used to remove the `.j2` extension from the template file
    owner: root
    group: root
    mode: "0600"
  with_items:
    - snapraid-runner.conf.j2
    - snapraid-runner.no-threshold.conf.j2

- name: Adds crontab task for SnapRAID-runner
  become: yes
  ansible.builtin.cron:
    name: SnapRAID-runner
    minute: "0"
    hour: "01"
    user: root
    job: python3 /opt/snapraid-runner/snapraid-runner.py -c /opt/snapraid-runner/snapraid-runner.conf
    state: present

- name: Adding log directory for SnapRAID-runner
  become: yes
  ansible.builtin.file:
    path: /var/log/snapraid #/snapraid.log
    state: directory

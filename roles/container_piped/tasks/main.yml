- name: Creating folders
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
  loop:
    - "{{ docker_mounts_directory }}/piped/postgresql"
    - "{{ docker_mounts_directory }}/piped/proxy"
    - /mnt/storage/piped/nginx
    - /mnt/storage/backups/piped

- name: Copying Piped configuration
  ansible.builtin.template:
    src: config.properties
    dest: /mnt/storage/piped/config.properties
    mode: 0600
- name: Copying nginx configuration for Piped proxy
  ansible.builtin.template:
    src: "nginx/{{ item }}"
    dest: "/mnt/storage/piped/nginx/{{ item }}"
    mode: 0600
  loop:
    - nginx.conf
    - pipedproxy.conf
    - ytproxy.conf

- name: Deploying hooks for database backups
  ansible.builtin.copy:
    src: pgsql_backups_hooks
    dest: "{{ docker_compose_directory }}/piped/hooks/"
    mode: 0770

- ansible.builtin.include_role:
    name: snyssen.compose_deploy
  vars:
    stack_name: "piped"

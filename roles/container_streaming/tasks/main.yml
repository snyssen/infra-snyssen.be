- name: Creating folders
  become: true
  ansible.builtin.file:
    path: "{{ item.src }}"
    state: directory
    owner: "{{ item.owner | default('33') }}" # 33 as in www-data, i.e. the default PHP, and most importantly Nextcloud, user
    group: "{{ item.group | default(ansible_user_gid) }}"
    mode: "{{ item.mode | default('774') }}"
  with_items:
    # jellyfin
    - src: "{{ docker_mounts_directory }}/jellyfin/data"
      mode: "750"
    - src: "{{ docker_mounts_directory }}/jellyfin/config"
      mode: "750"
    - src: "{{ docker_mounts_directory }}/jellyfin/cache"
      mode: "750"
    - src: "{{ docker_mounts_directory }}/jellyfin/logs"
      mode: "750"
    # media
    - src: "/mnt/storage/streaming/media/movies"
    - src: "/mnt/storage/streaming/media/tv"
    - src: "/mnt/storage/streaming/media/music"
    - src: "/mnt/storage/streaming/media/music_vi"
    - src: "/mnt/storage/streaming/media/audiobooks"
    - src: "/mnt/storage/streaming/media/audiobooks_vi"
    - src: "/mnt/storage/streaming/media/podcasts"
    - src: "/mnt/storage/streaming/media/podcasts_vi"
    - src: "/mnt/storage/streaming/media/books"
    # audiobookshelf
    - src: "{{ docker_mounts_directory }}/audiobookshelf/config"
      mode: "750"
    - src: "{{ docker_mounts_directory }}/audiobookshelf/metadata"
      mode: "750"
    # torrents
    - src: "/mnt/storage/torrent" # config
      mode: "750"
    - src: "/mnt/storage/streaming/torrent" # downloads
      mode: "750"
    # usenet
    - src: "/mnt/storage/usenet" # config
      mode: "750"
    - src: "/mnt/storage/streaming/usenet" # downloads
      mode: "750"
    # sonarr
    - src: "{{ docker_mounts_directory }}/sonarr/config"
      mode: "750"
    # radarr
    - src: "{{ docker_mounts_directory }}/radarr/config"
      mode: "750"
    # lidarr
    - src: "{{ docker_mounts_directory }}/lidarr/config"
      mode: "750"
    # prowlarr
    - src: "{{ docker_mounts_directory }}/prowlarr/config"
      mode: "750"
    # bazarr
    - src: "{{ docker_mounts_directory }}/bazarr/config"
      mode: "750"
    # ytdl-sub
    - src: "{{ docker_mounts_directory }}/ytdl-sub/config/crontabs"
      mode: "750"
    # lidatube
    - src: "{{ docker_mounts_directory }}/lidatube/config"
      mode: "750"
    # lidify
    - src: "{{ docker_mounts_directory }}/lidify/config"
      mode: "750"

- name: Deploying Sabnzbd config
  become: true
  ansible.builtin.template:
    src: sabnzbd.ini
    dest: /mnt/storage/usenet/sabnzbd.ini
    mode: "600"
    owner: "33"
    group: "{{ ansible_user_gid }}"

- name: Create push monitor for ytdl-sub
  lucasheld.uptime_kuma.monitor:
    name: ytdl-sub
    type: push
    interval: 21600 # 6 hours
    retryInterval: 10800 # 3 hours
- name: Retrieve push monitor info
  lucasheld.uptime_kuma.monitor_info:
    name: ytdl-sub
  register: ytdlsub_push_monitor

- name: Deploy ytdl-sub configuration and scripts
  become: true
  ansible.builtin.template:
    src: "{{ item.src }}"
    dest: "{{ docker_mounts_directory }}/ytdl-sub/{{ item.filename }}"
    owner: "33"
    group: "{{ ansible_user_gid }}"
    mode: "750"
  loop:
    - src: ytdl-sub/config.yaml
      filename: "config/"
    - src: ytdl-sub/subscriptions.yaml
      filename: "config/"
    - src: ytdl-sub/cron_cmd.sh
      filename: "config/cron"

- name: Create ytdl-sub log file
  become: true
  ansible.builtin.file:
    path: "{{ docker_mounts_directory }}/ytdl-sub/config/ytdl-sub.log"
    state: touch
    mode: "750"
    owner: "33"
    group: "{{ ansible_user_gid }}"
    modification_time: preserve
    access_time: preserve

- ansible.builtin.include_role:
    name: snyssen.compose_deploy
  vars:
    stack_name: "streaming"

- name: Create monitors
  lucasheld.uptime_kuma.monitor:
    name: "{{ item.name }}"
    type: "{{ item.type | default('http') }}"
    url: "{{ item.url }}"
    keyword: "{{ item.keyword | default('') }}"
  loop:
    - name: jellyfin
      url: https://streaming.snyssen.be/health
      type: keyword
      keyword: Healthy
    - name: bazarr
      url: https://bazarr.snyssen.be
    - name: lidarr
      url: https://lidarr.snyssen.be
    - name: prowlarr
      url: https://prowlarr.snyssen.be
    - name: radarr
      url: https://radarr.snyssen.be
    - name: sonarr
      url: https://sonarr.snyssen.be

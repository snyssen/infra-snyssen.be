- name: Creating folders
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "744"
    owner: "{{ ansible_user_uid }}"
  with_items:
    # jellyfin
    - "{{ docker_mounts_directory }}/jellyfin/data"
    - "{{ docker_mounts_directory }}/jellyfin/config"
    - "{{ docker_mounts_directory }}/jellyfin/cache"
    - "{{ docker_mounts_directory }}/jellyfin/logs"
    - "/mnt/storage/streaming/media/movies"
    - "/mnt/storage/streaming/media/tv"
    - "/mnt/storage/streaming/media/music"
    # torrents
    - "/mnt/storage/torrent"
    - /mnt/storage/streaming/torrent
    # usenet
    - "/mnt/storage/usenet"
    - "/mnt/storage/streaming/usenet"
    # sonarr
    - "{{ docker_mounts_directory }}/sonarr/config"
    # radarr
    - "{{ docker_mounts_directory }}/radarr/config"
    # lidarr
    - "{{ docker_mounts_directory }}/lidarr/config"
    # prowlarr
    - "{{ docker_mounts_directory }}/prowlarr/config"
    # bazarr
    - "{{ docker_mounts_directory }}/bazarr/config"
    # ytdl-sub
    - "{{ docker_mounts_directory }}/ytdl-sub/config"
    - /mnt/storage/streaming/ytdl-sub/downloads

- name: Deploying Sabnzbd config
  ansible.builtin.template:
    src: sabnzbd.ini
    dest: /mnt/storage/usenet/sabnzbd.ini
    mode: "600"

- name: Deploy ytdl-sub configuration
  ansible.builtin.template:
    src: "{{ item.src }}"
    dest: "{{ docker_mounts_directory }}/ytdl-sub/config/"
    owner: "{{ ansible_user_uid }}"
    group: "{{ ansible_user_gid }}"
    mode: "640"
  loop:
    - src: ytdl-sub/config.yaml
    - src: ytdl-sub/subscriptions.yaml

- ansible.builtin.include_role:
    name: snyssen.compose_deploy
  vars:
    stack_name: "streaming"

- name: Add cron job for ytdl-sub
  become: true
  ansible.builtin.cron:
    name: ytdl-sub
    hour: "*/6"
    user: root
    job: >-
      curl --retry 5 -o /dev/null https://hc-ping.com/{{ ytdl_sub__healthcheck_id }}/start
      && docker exec -u abc ytdl-sub ytdl-sub sub --config /config/config.yaml /config/subscriptions.yaml
      && curl --retry 5 -o /dev/null https://hc-ping.com/{{ ytdl_sub__healthcheck_id }}/$?
    state: present

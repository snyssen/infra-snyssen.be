version: "3"
services:

  restic_local: &restic-config
    image: lobaro/restic-backup-docker
    restart: unless-stopped
    container_name: restic_local
    hostname: "{{ ansible_fqdn }}"
    environment: &restic-env
      RESTIC_REPOSITORY: "{{ backups__local_destination }}"
      RESTIC_PASSWORD: "{{ backups__encryption_key }}"
      BACKUP_CRON: 15 3 * * *
      HEALTHCHECK_ID: "{{ backups__local_healthcheck_id }}"
      RESTIC_FORGET_ARGS: --prune --keep-hourly 12 --keep-daily 7 --keep-weekly 2 --keep-monthly 2 --keep-yearly 1
    volumes:
      - ./hooks:/hooks
      # TODO: Since the local backup should be cheaper and faster, we could actually backup more things, such as movies and tv series
      # Folders to backup
      - /mnt/storage/nextcloud:/data/nextcloud
      - /mnt/storage/pictures:/data/pictures
      - /mnt/storage/recipes:/data/recipes
      - /mnt/storage/backups:/data/backups
      - /mnt/storage/streaming/media/music:/data/streaming/media/music
      - /mnt/storage/jellyfin/config:/data/jellyfin/config
      # - "{{ docker_mounts_directory }}/jellyfin/data:/data/jellyfin/data" # I don't think we should actually include this folder but I'm not sure
      - "{{ docker_mounts_directory }}/sonarr/config:/data/sonarr/config"
      - "{{ docker_mounts_directory }}/radarr/config:/data/radarr/config"
      - "{{ docker_mounts_directory }}/lidarr/config:/data/lidarr/config"
      - "{{ docker_mounts_directory }}/prowlarr/config:/data/prowlarr/config"

  restic_remote:
    <<: *restic-config
    container_name: restic_remote
    hostname: "{{ ansible_fqdn }}"
    environment:
      <<: *restic-env
      RESTIC_REPOSITORY: "{{ backups__remote_destination }}"
      BACKUP_CRON: 45 3 * * *
      B2_ACCOUNT_ID: "{{ backups__access_id_remote }}"
      B2_ACCOUNT_KEY: "{{ backups__access_secret_remote }}"
      HEALTHCHECK_ID: "{{ backups__remote_healthcheck_id }}"

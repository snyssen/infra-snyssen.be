- name: Creating folders
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
  with_items:
    - "{{ docker_mounts_directory }}/traefik"
    - "{{ docker_mounts_directory }}/gluetun"
    - "{{ docker_mounts_directory }}/authelia"

- name: Deploy Authelia config
  become: true
  ansible.builtin.template:
    src: authelia/configuration.yml
    dest: "{{ docker_mounts_directory }}/authelia/config/"
    owner: "{{ ansible_user_uid }}"
    group: "{{ ansible_user_gid }}"
    mode: "400"
  register: authelia_conf

- ansible.builtin.include_role:
    name: snyssen.compose_deploy
  vars:
    stack_name: "backbone"
    docker_compose_state: "{{ 'restarted' if authelia_conf.changed else 'present' }}"
# TODO: manage LDAP groups and technical users (human users will be managed manually)

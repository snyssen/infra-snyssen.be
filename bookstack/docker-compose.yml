# IMPORTANT: First launch requires some changes to this file.
# Please read the comments carefully then revert all changes and relaunch everything

version: "3"
services:
  bookstack:
    image: solidnerd/bookstack
    container_name: bookstack
    environment:
      - APP_URL=https://wiki.snyssen.be # comment on first launch
      - DB_HOST=bookstack_db:3306
      - DB_USERNAME=bookstack
      - DB_PASSWORD=${DB_PASS}
      - DB_DATABASE=bookstack
      - MAIL_DRIVER=smtp
      - MAIL_HOST=${SMTP_SERVER}
      - MAIL_PORT=${SMTP_PORT}
      - MAIL_ENCRYPTION=tls
      - MAIL_USERNAME=${SMTP_USER}
      - MAIL_PASSWORD=${SMTP_PASSWORD}
      - MAIL_FROM=bookstack@snyssen.be
      - MAIL_FROM_NAME=BookStack
    labels:
      - traefik.enable=true
      - traefik.http.routers.bookstack.entryPoints=websecure
      - traefik.http.routers.bookstack.rule=Host(`wiki.snyssen.be`)
      - traefik.http.routers.bookstack.tls=true
      - traefik.http.routers.bookstack.tls.certresolver=le
      - traefik.http.routers.bookstack.service=bookstack
      - traefik.http.services.bookstack.loadBalancer.server.port=8080
    volumes:
      - ${DOCKER_DIRECTORY}/bookstack/uploads:/var/www/bookstack/public/uploads
      - ${DOCKER_DIRECTORY}/bookstack/storage-uploads:/var/www/bookstack/storage/uploads
    restart: unless-stopped
    networks:
      - internal
      - web
# uncomment the following on first launch.
# Once stack is launched, got to http://<ip>:8080
# If everything works normally, you should see the login page
# You can now comment these lines once again and restart the stack
#    ports:
#      - 8080:8080
    depends_on:
      - bookstack_db

  bookstack_db:
    image: mariadb
    container_name: bookstack_db
    networks:
      - internal
    environment:
    - MYSQL_ROOT_PASSWORD=${DB_PASS}
    - MYSQL_DATABASE=bookstack
    - MYSQL_USER=bookstack
    - MYSQL_PASSWORD=${DB_PASS}
    volumes:
    - ${DOCKER_DIRECTORY}/bookstack/mariadb:/var/lib/mysql

networks:
  web:
    external: true
  internal:

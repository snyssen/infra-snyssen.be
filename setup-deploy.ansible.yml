# TODO: move below into common setup
- hosts: dns
  roles:
    - name: geerlingguy.docker
      become: true
      vars:
        docker_users:
          - "{{ ansible_user_id }}"
  tasks:
    - name: Installing packages
      become: true
      ansible.builtin.package:
        name:
          - python3
          - python3-pip
          - python3-docker
          - docker-compose # docker role does not seem to install it correctly...
          # Useful tools:
          - nano
          - htop
          - screen
          - curl
        state: present
- hosts: dns
  roles:
    - name: dns_adguard

- hosts: apps,backup
  roles:
    - setup_common
    - setup_storage

- hosts: monitored
  roles:
    - name: undergreen.prometheus-node-exporter
      become: true
      vars:
        prometheus_node_exporter_config_flags:
          "web.listen-address": "0.0.0.0:9100"
          "log.level": "info"
  tasks:
    - name: Permitting traffic for Prometheus Node exporter
      become: true
      ansible.posix.firewalld:
        port: 9100/tcp
        permanent: true
        state: enabled

- hosts: apps
  roles:
    - role: setup_snapraid
      become: true
      when: skip_snapraid is not defined or not skip_snapraid
    - role: stacks_deploy
      when: skip_stacks is not defined or not skip_stacks

- hosts: backup
  roles:
    - container_rest
    - container_scrutiny
  tasks:
    - name: Create backup user
      become: true
      ansible.builtin.user:
        name: backup
        password_lock: true
        generate_ssh_key: true
        state: present
    - name: Allow backup user to shutdown computer
      become: true
      community.general.sudoers:
        name: allow-poweroff-backup
        state: present
        user: backup
        commands:
          - /usr/sbin/poweroff
    - name: Authorize connection with backup SSH key
      become: true
      ansible.posix.authorized_key:
        user: backup
        state: present
        key: "{{ lookup('file', 'backup_rsa.pub') }}"

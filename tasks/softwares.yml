- name: Upgrading all packages
  become: yes
  ansible.builtin.dnf:
    name: "*"
    state: latest

- name: Enabling SnapRAID COPR repos
  become: yes
  community.general.copr:
    name: pauken/SnapRAID
    state: enabled
- name: Installing SnapRAID
  become: yes
  ansible.builtin.dnf:
    name: snapraid
    state: latest

- name: Getting uri of latest MergerFS .rpm
  ansible.builtin.uri:
    url: https://api.github.com/repos/trapexit/mergerfs/releases/latest
    return_content: true
  register: mergerfs_latest
- name: Downloading and installing MergerFS V{{ mergerfs_latest.json.tag_name }}
  become: yes
  loop: "{{ mergerfs_latest.json.assets }}"
  when: "'fc{{ ansible_distribution_major_version }}.x86_64.rpm' in item.name"
  ansible.builtin.dnf:
    name: "{{ item.browser_download_url }}"
    state: present
    disable_gpg_check: yes # Unfortunately I could not find the MergerFS GPG key

- name: Adding custom repositories
  become: yes
  ansible.builtin.yum_repository:
    name: "{{ item.name }}"
    description: "{{ item.description }}"
    baseurl: "{{ item.baseurl }}"
    gpgcheck: "{{ item.gpgcheck }}"
    repo_gpgcheck: "{{ item.repo_gpgcheck }}"
    gpgkey: "{{ item.gpgkey }}"
    priority: "{{ item.priority }}"
  loop:
    - {
        name: "docker-ce-stable",
        description: "Docker CE Stable - $basearch",
        baseurl: "https://download.docker.com/linux/fedora/$releasever/$basearch/stable",
        gpgcheck: true,
        repo_gpgcheck: false,
        gpgkey: "https://download.docker.com/linux/fedora/gpg",
        priority: "99",
      }
- name: Installing other packages
  become: yes
  ansible.builtin.package:
    name:
      - git
      - docker-ce
      - docker-compose
      - python3-pip
      - zsh
    state: present
- name: Enabling services
  become: yes
  ansible.builtin.systemd:
    name: docker
    state: started
    enabled: yes